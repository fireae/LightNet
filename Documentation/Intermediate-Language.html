<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Intermediate Language - LightNet</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link href="../css/codehilite.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Intermediate Language";
    var mkdocs_page_input_path = "Documentation/Intermediate-Language.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> LightNet</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Getting-Started.html">Getting Started</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Documentation</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="Introduction.html">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="Project-Structure.html">Project Structure</a>
                </li>
                <li class="">
                    
    <a class="" href="Build-Options.html">Build Options</a>
                </li>
                <li class="">
                    
    <a class="" href="Data-Structures.html">Data Structures</a>
                </li>
                <li class="">
                    
    <a class="" href="Intermediate-Representation.html">Intermediate Representation</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="Intermediate-Language.html">Intermediate Language</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#intermediate-language">Intermediate Language</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#basic-il-format">Basic IL Format</a></li>
        
            <li><a class="toctree-l4" href="#wrap-operators-with-macros">Wrap Operators with Macros</a></li>
        
            <li><a class="toctree-l4" href="#embeded-scripts">Embeded Scripts</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="Operator-Description.html">Operator Description</a>
                </li>
                <li class="">
                    
    <a class="" href="Optimizer-Description.html">Optimizer Description</a>
                </li>
                <li class="">
                    
    <a class="" href="Miscellaneous.html">Miscellaneous</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Hacking.html">Hacking</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">LightNet</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Documentation &raquo;</li>
        
      
    
    <li>Intermediate Language</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="intermediate-language">Intermediate Language<a class="headerlink" href="#intermediate-language" title="Permanent link">&para;</a></h1>
<h2 id="basic-il-format">Basic IL Format<a class="headerlink" href="#basic-il-format" title="Permanent link">&para;</a></h2>
<p>The <a href="Intermediate-Representation.html">Intermediate Representation</a> may seems
simple at the first glance. But when we're writing a real neural network,
the model file in JSON IR format is easily getting tens of thousands of lines,
which is still piece of cake for computers, but a nightmare for humans.</p>
<p>Thus, LightNet provides a "concise version" of JSON IR format, which contains
the exactly the same information as JSON IR, called LightNet Intermediate
Language (IL), which can be transformed to JSON IR by <code>il2json.pl</code> (installed
by default).</p>
<p>The basic format for an operator's representation in IL is:</p>
<div class="codehilite"><pre><span></span><span class="n">OPTYPE</span><span class="p">(</span><span class="n">TENSOR_IN_ARG_NAME1</span><span class="o">=</span><span class="n">TENSOR_IN_NAME1</span><span class="p">,</span> 
       <span class="n">TENSOR_IN_ARG_NAME2</span><span class="o">=</span><span class="n">TENSOR_IN_NAME2</span><span class="p">,</span> <span class="p">...</span> <span class="o">|</span>
       <span class="n">TENSOR_OUT_ARG_NAME1</span><span class="o">=</span><span class="n">TENSOR_OUT_NAME1</span><span class="p">,</span>
       <span class="n">TENSOR_OUT_ARG_NAME1</span><span class="o">=</span><span class="n">TENSOR_OUT_NAME1</span><span class="p">,</span> <span class="p">...</span> <span class="o">|</span>
       <span class="n">PARAM_ARG_NAME1</span><span class="o">=</span><span class="n">PARAM_VALUE1</span><span class="p">,</span>
       <span class="n">PARAM_ARG_NAME2</span><span class="o">=</span><span class="n">PARAM_VALUE2</span><span class="p">,</span> <span class="p">...);</span>
</pre></div>


<p>For example, <a href="Intermediate-Representation.html#example">the example IR used in Intermediate Representation section</a>
that composed of 3 operators (<code>create1</code>, <code>slice1</code>, <code>print1</code>) can also be written
in IL:</p>
<div class="codehilite"><pre><span></span><span class="n">create</span><span class="p">(</span><span class="o">|</span> <span class="n">dst</span><span class="o">=</span><span class="n">tensor1</span> <span class="o">|</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TL_FLOAT</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
       <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">ran</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">from_file</span><span class="o">=</span><span class="nb">false</span><span class="p">);</span>
<span class="n">slice</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">tensor1</span> <span class="o">|</span> <span class="n">dst</span><span class="o">=</span><span class="n">tensor2</span> <span class="o">|</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
<span class="n">print</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">tensor2</span> <span class="o">|</span> <span class="o">|</span> <span class="n">msg</span><span class="o">=</span><span class="s">&quot;tensor2:&quot;</span><span class="p">);</span>
</pre></div>


<p>Save the above code in <code>example.net</code>, and <code>il2json.pl</code> can generate the same code
as in the <a href="Intermediate-Representation.html#example">example IR</a>:</p>
<div class="codehilite"><pre><span></span>$ il2json.pl example.net -o example.json
</pre></div>


<p>Then you can feed <code>example.json</code> directly to <code>lightnet</code>. Or you can just combine 
<code>il2json</code> and <code>lightnet</code> with a pipe:</p>
<div class="codehilite"><pre><span></span>$ il2json.pl example.net | lightnet -
tensor2:
[[2.000 3.000 4.000]
 [6.000 7.000 8.000]]
info: run time: 0.000062s
</pre></div>


<h2 id="wrap-operators-with-macros">Wrap Operators with Macros<a class="headerlink" href="#wrap-operators-with-macros" title="Permanent link">&para;</a></h2>
<p>The IL interpreter utlizes the C preprocessor of GCC, thus all C preprocessor
syntaxes are legal in an IL.</p>
<p>For example, it is common to have a <code>conv2d</code> and a <code>relu</code> operator in a row in
NN models. Instead of writing <code>conv2d</code> and <code>relu</code> repeatedly, we can use
<code>#define</code> directive to wrap them in a macro for future uses.</p>
<div class="codehilite"><pre><span></span><span class="cp">#define conv(in_name, out_name, in_c, out_c,                            \</span>
<span class="cp">             _size, _stride, _padding, _dilation)                       \</span>
<span class="cp">    create(| dst=out_name##_wts |                                       \</span>
<span class="cp">           dtype=TL_FLOAT, dims=[out_c, in_c, _size, _size],            \</span>
<span class="cp">           ran=[-10, 10], data=[0], from_file=true);                    \</span>
<span class="cp">    create(| dst=out_name##_bias | dtype=TL_FLOAT, dims=[out_c],        \</span>
<span class="cp">           ran=[-10, 10], data=[0], from_file=true);                    \</span>
<span class="cp">    conv2d(src=in_name, weight=out_name##_wts, bias=out_name##_bias |   \</span>
<span class="cp">           dst=out_name | group=1, size=[_size, _size],                 \</span>
<span class="cp">           stride=[_stride, _stride],                                   \</span>
<span class="cp">           padding=[_padding, _padding, _padding, _padding],            \</span>
<span class="cp">           autopad=&quot;NOTSET&quot;,                                            \</span>
<span class="cp">           dilation=[_dilation, _dilation])</span>

<span class="cp">#define conv_relu(in_name, out_name, in_c, out_c,       \</span>
<span class="cp">                  _size, _stride, _padding, _dilation)  \</span>
<span class="cp">    conv(in_name, out_name##_conv, in_c, out_c,         \</span>
<span class="cp">         _size, _stride, _padding, _dilation);          \</span>
<span class="cp">    relu(src=out_name##_conv | dst=out_name |)</span>
</pre></div>


<p>The above code first defined a <code>conv</code> macro, which consists of two <code>create</code>
operators and a <code>conv2d</code> operator. The two <code>create</code>s create the tensors
for the weight and the bias of the <code>conv2d</code>. The <code>conv2d</code> operator does the
convolution algorithm using the input tensor named <code>in_name</code>, to the output
tensor named <code>out_name</code>, with a weight tensor named <code>out_name##wts</code> and a
bias tensor named <code>out_name##bias</code>. The <code>##</code> is the string-concatation operator
in the C preprocessor which concat the macro parameter <code>out_name</code> with <code>wts</code> 
or <code>bias</code>, so that when we calls <code>conv(tensor1, tensor2,...)</code>, the weight 
tensor gets <code>tensor2_wts</code> and the bias tensor gets <code>tensor2_bias</code> as their names
automatically.</p>
<p>Some readers may notice that some macro parameters are prefixed with a <code>_</code>.
That's to prevent the parameter names from conflicting with the argument
names of the operators in the macro, such as the <code>padding</code> argument of <code>conv2d</code>.</p>
<p>The code then defined a <code>conv_relu</code> macro, which calls the
former <code>conv</code> macro and feeds its output to the input of a <code>relu</code> operator.</p>
<h2 id="embeded-scripts">Embeded Scripts<a class="headerlink" href="#embeded-scripts" title="Permanent link">&para;</a></h2>
<p>Sometimes we want some constant expressions to be calculated before we actually
translate the IL, which cannot be done by the C preprocessor.
So after the C preprocessor, IL supports embeded scripts to process the IL text
further.</p>
<p>Embeded scripts are enclosed in <code>${eval ... }</code> expressions. Suppose we needs
to get the anchor number in an object detection network 
(such as <a href="https://arxiv.org/abs/1612.01051">SqueezeDet</a>), whose anchor number can be
calculated as</p>
<div class="codehilite"><pre><span></span>anchor_num = anchors_per_grid * grid_height * grid_width
</pre></div>


<p>Using embeded scripts, this may be written as:</p>
<div class="codehilite"><pre><span></span><span class="cp">#define ANCHORS_PER_GRID 9</span>
<span class="cp">#define CONVOUT_H 12</span>
<span class="cp">#define CONVOUT_W 20</span>
<span class="cp">#define ANCHOR_NUM ${eval ANCHOR_PER_GRID * CONVOUT_H * CONVOUT_W}</span>
</pre></div>


<p>Embeded scripts are actually Perl code snippets. So in principle, any legal Perl
code can be run in an <code>eval</code> expression.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Since embeded scripts are Perl code, be cautious that malicious code may
do nasty things to your system if an untrusty IL is interpreted with
privileged priorities. Of course, there is <strong>never</strong> a good reason for an IL
text to be translated with privileges.</p>
</div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Operator-Description.html" class="btn btn-neutral float-right" title="Operator Description">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="Intermediate-Representation.html" class="btn btn-neutral" title="Intermediate Representation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/zhaozhixu/LightNet" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="Intermediate-Representation.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="Operator-Description.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../js/baidu_analyse.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
